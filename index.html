<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>Daily Expense Tracker</title>

  <!-- Tailwind CSS CDN（v3 版） -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js 用來畫圖 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* 可放少量自訂樣式（Tailwind 為主） */
    body {
      background: radial-gradient(circle at top, #e0f2fe 0, #f9fafb 40%, #f3f4f6 100%);
    }
  </style>
</head>
<body class="min-h-screen text-slate-800">
  <div class="max-w-5xl mx-auto px-4 py-6 md:py-8">
    <!-- 頂部：標題＋語言切換 -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
        <h1 id="t_title" class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-900">
          每日開支記錄
        </h1>
        <p id="t_subtitle" class="text-sm text-slate-600 mt-1">
          支援多貨幣、自動分類、localStorage 保存。
        </p>
      </div>
      <div class="flex items-center gap-2">
        <label for="lang-select" id="t_language_label" class="text-sm text-slate-600">
          語言
        </label>
        <select id="lang-select"
          class="text-sm rounded-md border border-slate-300 bg-white px-2 py-1 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
          <option value="zh">中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="ko">한국어</option>
        </select>
      </div>
    </header>

    <!-- 新增開支表單 -->
    <section class="bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-sm mb-5 p-4 md:p-5">
      <h2 id="t_add_title" class="text-lg font-semibold mb-3 text-slate-900">
        新增開支
      </h2>

      <div class="grid md:grid-cols-3 gap-3 mb-3">
        <div>
          <label id="t_label_date" for="date" class="block text-xs font-medium text-slate-600 mb-1">
            日期
          </label>
          <input type="date" id="date"
            class="w-full rounded-md border border-slate-300 px-2 py-1.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
        </div>

        <div>
          <label id="t_label_amount" for="amount" class="block text-xs font-medium text-slate-600 mb-1">
            金額
          </label>
          <input type="number" id="amount" step="0.01" placeholder="13.2"
            class="w-full rounded-md border border-slate-300 px-2 py-1.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
        </div>

        <div>
          <label id="t_label_currency" for="currency" class="block text-xs font-medium text-slate-600 mb-1">
            貨幣
          </label>
          <select id="currency"
            class="w-full rounded-md border border-slate-300 px-2 py-1.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
            <option value="HKD">HKD</option>
            <option value="USD">USD</option>
            <option value="JPY">JPY</option>
            <option value="KRW">KRW</option>
            <option value="CNY">CNY</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mb-3">
        <div class="md:col-span-2">
          <label id="t_label_desc" for="description" class="block text-xs font-medium text-slate-600 mb-1">
            描述
          </label>
          <input type="text" id="description" placeholder="例如 MTR 黃埔→會展 車費"
            class="w-full rounded-md border border-slate-300 px-2 py-1.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
        </div>
        <div>
          <label id="t_label_category" for="category" class="block text-xs font-medium text-slate-600 mb-1">
            類別（可改）
          </label>
          <select id="category"
            class="w-full rounded-md border border-slate-300 px-2 py-1.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
            <option value="auto">自動判斷</option>
            <option value="交通">交通</option>
            <option value="飲食">飲食</option>
            <option value="娛樂">娛樂</option>
            <option value="健身">健身</option>
            <option value="學習">學習</option>
            <option value="家庭">家庭</option>
            <option value="投資">投資</option>
            <option value="其他">其他</option>
          </select>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2 mb-1">
        <button id="btn-auto-categorize"
          class="inline-flex items-center rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-sky-500">
          自動重新分類
        </button>
        <button id="btn-add"
          class="inline-flex items-center rounded-md bg-sky-600 px-4 py-1.5 text-xs font-medium text-white shadow-sm hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
          加入開支
        </button>
      </div>
      <p id="t_hint_keywords" class="text-[11px] text-slate-500 mt-1">
        提示：描述入關鍵字（例如「MTR、lunch、gym、Netflix」），系統會幫你自動歸類。
      </p>
    </section>

    <!-- 月份總結 -->
    <section class="bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-sm mb-5 p-4 md:p-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
        <h2 id="t_summary_title" class="text-lg font-semibold text-slate-900">
          月份總結
        </h2>
        <div class="flex flex-wrap gap-3 items-center">
          <div>
            <label id="t_label_month" for="month-select"
              class="block text-xs font-medium text-slate-600 mb-1">
              選擇月份
            </label>
            <input type="month" id="month-select"
              class="rounded-md border border-slate-300 px-2 py-1.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
          </div>
          <div>
            <p id="t_label_month_total" class="text-xs font-medium text-slate-600 mb-1">
              本月總開支（HKD）
            </p>
            <div id="month-total" class="text-lg font-semibold text-sky-700">
              HKD 0.00
            </div>
          </div>
        </div>
      </div>
      <div id="category-summary" class="text-sm text-slate-700"></div>
    </section>

    <!-- 開支列表 -->
    <section class="bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-sm mb-5 p-4 md:p-5">
      <h2 id="t_list_title" class="text-lg font-semibold mb-3 text-slate-900">
        開支列表
      </h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-xs md:text-sm">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr>
              <th id="t_th_date" class="px-2 py-2 text-left font-medium text-slate-600">日期</th>
              <th id="t_th_desc" class="px-2 py-2 text-left font-medium text-slate-600">描述</th>
              <th id="t_th_original" class="px-2 py-2 text-right font-medium text-slate-600">原始金額</th>
              <th id="t_th_hkd" class="px-2 py-2 text-right font-medium text-slate-600">HKD（金額）</th>
              <th id="t_th_category" class="px-2 py-2 text-left font-medium text-slate-600">類別</th>
              <th id="t_th_action" class="px-2 py-2 text-left font-medium text-slate-600">操作</th>
            </tr>
          </thead>
          <tbody id="expense-tbody" class="divide-y divide-slate-100">
          </tbody>
        </table>
      </div>
    </section>

    <!-- 每月變化圖 -->
    <section class="bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-sm mb-5 p-4 md:p-5">
      <h2 id="t_chart_title" class="text-lg font-semibold mb-3 text-slate-900">
        每月總開支變化
      </h2>
      <canvas id="monthlyChart" height="130"></canvas>
    </section>
  </div>

  <script>
    // ========== 多語言字典 ==========
    const translations = {
      zh: {
        title: "每日開支記錄",
        subtitle: "支援多貨幣、自動分類、localStorage 保存。",
        language_label: "語言",
        add_title: "新增開支",
        label_date: "日期",
        label_amount: "金額",
        label_currency: "貨幣",
        label_desc: "描述",
        label_category: "類別（可改）",
        btn_auto: "自動重新分類",
        btn_add: "加入開支",
        hint_keywords: "提示：描述入關鍵字（例如「MTR、lunch、gym、Netflix」），系統會幫你自動歸類。",
        summary_title: "月份總結",
        label_month: "選擇月份",
        label_month_total: "本月總開支（HKD）",
        list_title: "開支列表",
        th_date: "日期",
        th_desc: "描述",
        th_original: "原始金額",
        th_hkd: "HKD（金額）",
        th_category: "類別",
        th_action: "操作",
        chart_title: "每月總開支變化",
        no_data_month: "本月暫未有開支紀錄。",
        btn_delete: "刪除",
        alert_amount: "請輸入正確金額",
        alert_desc_first: "請先輸入描述",
        confirm_delete: "確定刪除這筆開支？",
        rate_fail: "匯率取得失敗，請稍後再試或改用 HKD 輸入。"
      },
      en: {
        title: "Daily Expense Tracker",
        subtitle: "Multi-currency, auto-categorization, and localStorage persistence.",
        language_label: "Language",
        add_title: "Add Expense",
        label_date: "Date",
        label_amount: "Amount",
        label_currency: "Currency",
        label_desc: "Description",
        label_category: "Category (editable)",
        btn_auto: "Auto categorize",
        btn_add: "Add expense",
        hint_keywords: "Tip: Use keywords like \"MTR, lunch, gym, Netflix\" and the system will auto-categorize.",
        summary_title: "Monthly Summary",
        label_month: "Select month",
        label_month_total: "Total this month (HKD)",
        list_title: "Expense List",
        th_date: "Date",
        th_desc: "Description",
        th_original: "Original",
        th_hkd: "Amount in HKD",
        th_category: "Category",
        th_action: "Action",
        chart_title: "Monthly Expense Trend",
        no_data_month: "No expenses recorded for this month.",
        btn_delete: "Delete",
        alert_amount: "Please enter a valid amount.",
        alert_desc_first: "Please enter description first.",
        confirm_delete: "Delete this expense?",
        rate_fail: "Failed to fetch exchange rate. Try again later or use HKD."
      },
      ja: {
        title: "毎日の支出記録",
        subtitle: "複数通貨、自動分類、localStorage でデータ保存。",
        language_label: "言語",
        add_title: "支出を追加",
        label_date: "日付",
        label_amount: "金額",
        label_currency: "通貨",
        label_desc: "内容",
        label_category: "カテゴリ（変更可）",
        btn_auto: "自動分類",
        btn_add: "追加",
        hint_keywords: "ヒント：「MTR、lunch、gym、Netflix」などのキーワードを入れると自動分類されます。",
        summary_title: "月次サマリー",
        label_month: "月を選択",
        label_month_total: "今月合計（HKD）",
        list_title: "支出一覧",
        th_date: "日付",
        th_desc: "内容",
        th_original: "元の金額",
        th_hkd: "HKD 金額",
        th_category: "カテゴリ",
        th_action: "操作",
        chart_title: "月別支出推移",
        no_data_month: "今月の支出はまだありません。",
        btn_delete: "削除",
        alert_amount: "正しい金額を入力してください。",
        alert_desc_first: "先に内容を入力してください。",
        confirm_delete: "この支出を削除しますか？",
        rate_fail: "為替レートの取得に失敗しました。後でもう一度試すか HKD で入力してください。"
      },
      ko: {
        title: "일일 지출 기록",
        subtitle: "다중 통화, 자동 분류, localStorage 저장 지원.",
        language_label: "언어",
        add_title: "지출 추가",
        label_date: "날짜",
        label_amount: "금액",
        label_currency: "통화",
        label_desc: "설명",
        label_category: "카테고리(수정 가능)",
        btn_auto: "자동 분류",
        btn_add: "지출 추가",
        hint_keywords: "팁: \"MTR, lunch, gym, Netflix\" 같은 키워드를 사용하면 자동으로 분류됩니다.",
        summary_title: "월별 요약",
        label_month: "월 선택",
        label_month_total: "이번 달 합계 (HKD)",
        list_title: "지출 목록",
        th_date: "날짜",
        th_desc: "설명",
        th_original: "원금액",
        th_hkd: "HKD 금액",
        th_category: "카테고리",
        th_action: "작업",
        chart_title: "월별 지출 추이",
        no_data_month: "이번 달에 기록된 지출이 없습니다.",
        btn_delete: "삭제",
        alert_amount: "올바른 금액을 입력하세요.",
        alert_desc_first: "먼저 설명을 입력하세요.",
        confirm_delete: "이 지출을 삭제할까요?",
        rate_fail: "환율을 가져오지 못했습니다. 나중에 다시 시도하거나 HKD로 입력하세요."
      }
    };

    const LANG_KEY = 'hk_expense_lang';

    function applyLanguage(lang) {
      const t = translations[lang] || translations['zh'];

      document.getElementById('t_title').textContent = t.title;
      document.getElementById('t_subtitle').textContent = t.subtitle;
      document.getElementById('t_language_label').textContent = t.language_label;
      document.getElementById('t_add_title').textContent = t.add_title;
      document.getElementById('t_label_date').textContent = t.label_date;
      document.getElementById('t_label_amount').textContent = t.label_amount;
      document.getElementById('t_label_currency').textContent = t.label_currency;
      document.getElementById('t_label_desc').textContent = t.label_desc;
      document.getElementById('t_label_category').textContent = t.label_category;
      document.getElementById('btn-auto-categorize').textContent = t.btn_auto;
      document.getElementById('btn-add').textContent = t.btn_add;
      document.getElementById('t_hint_keywords').textContent = t.hint_keywords;
      document.getElementById('t_summary_title').textContent = t.summary_title;
      document.getElementById('t_label_month').textContent = t.label_month;
      document.getElementById('t_label_month_total').textContent = t.label_month_total;
      document.getElementById('t_list_title').textContent = t.list_title;
      document.getElementById('t_th_date').textContent = t.th_date;
      document.getElementById('t_th_desc').textContent = t.th_desc;
      document.getElementById('t_th_original').textContent = t.th_original;
      document.getElementById('t_th_hkd').textContent = t.th_hkd;
      document.getElementById('t_th_category').textContent = t.th_category;
      document.getElementById('t_th_action').textContent = t.th_action;
      document.getElementById('t_chart_title').textContent = t.chart_title;

      // 保存語言
      localStorage.setItem(LANG_KEY, lang);
    }

    function getLang() {
      return localStorage.getItem(LANG_KEY) || 'zh';
    }

    function getText(key) {
      const lang = getLang();
      const t = translations[lang] || translations['zh'];
      return t[key] || '';
    }

    // ========== 原本的邏輯（localStorage + 匯率 + 自動分類） ==========
    const STORAGE_KEY = 'hk_expense_tracker';
    const RATES_CACHE_KEY = 'hk_expense_rates_cache_v1';
    let expenses = [];
    let ratesCache = {};

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          expenses = JSON.parse(raw);
        } catch {
          expenses = [];
        }
      }
      const rawRates = localStorage.getItem(RATES_CACHE_KEY);
      if (rawRates) {
        try {
          ratesCache = JSON.parse(rawRates);
        } catch {
          ratesCache = {};
        }
      }
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
      localStorage.setItem(RATES_CACHE_KEY, JSON.stringify(ratesCache));
    }

    function uuid() {
      return 'xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function todayStr() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return yyyy + '-' + mm + '-' + dd;
    }

    function currentMonthStr() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      return yyyy + '-' + mm;
    }

    function autoCategorize(description) {
      if (!description) return '其他';
      const text = description.toLowerCase();

      if (text.includes('mtr') || text.includes('地鐵') || text.includes('octopus') ||
        text.includes('八達通') || text.includes('bus') || text.includes('的士') ||
        text.includes('taxi') || text.includes('uber') || text.includes('minibus') ||
        text.includes('小巴')) {
        return '交通';
      }
      if (text.includes('lunch') || text.includes('dinner') || text.includes('早餐') ||
        text.includes('lunchbox') || text.includes('cafe') || text.includes('restaurant') ||
        text.includes('麥當勞') || text.includes('mcdonald') || text.includes('kfc') ||
        text.includes('茶餐廳') || text.includes('星巴克') || text.includes('starbucks')) {
        return '飲食';
      }
      if (text.includes('gym') || text.includes('fitness') || text.includes('pure') ||
        text.includes('football') || text.includes('soccer') || text.includes('bowling') ||
        text.includes('running') || text.includes('跑步')) {
        return '健身';
      }
      if (text.includes('netflix') || text.includes('youtube') || text.includes('spotify') ||
        text.includes('disney') || text.includes('steam') || text.includes('game') ||
        text.includes('switch') || text.includes('ps5') || text.includes('cinema') ||
        text.includes('movie')) {
        return '娛樂';
      }
      if (text.includes('korean') || text.includes('japanese') || text.includes('course') ||
        text.includes('class') || text.includes('lesson') || text.includes('學校') ||
        text.includes('學費') || text.includes('補習')) {
        return '學習';
      }
      if (text.includes('family') || text.includes('家用') || text.includes('爸') ||
        text.includes('媽') || text.includes('父母')) {
        return '家庭';
      }
      if (text.includes('stock') || text.includes('etf') || text.includes('broker') ||
        text.includes('moomoo') || text.includes('futu') || text.includes('crypto') ||
        text.includes('bitcoin') || text.includes('tsm') || text.includes('msft') ||
        text.includes('nvda')) {
        return '投資';
      }
      return '其他';
    }

    async function getRateToHKD(currency) {
      if (currency === 'HKD') return 1;

      const today = todayStr();
      if (!ratesCache[today]) {
        ratesCache[today] = {};
      }
      if (ratesCache[today][currency]) {
        return ratesCache[today][currency];
      }

      const url = 'https://api.exchangerate.host/latest?base=' + currency + '&symbols=HKD';

      try {
        const res = await fetch(url);
        const data = await res.json();
        const rate = data && data.rates && data.rates['HKD'];
        if (!rate) throw new Error('no HKD rate');
        ratesCache[today][currency] = rate;
        saveToStorage();
        return rate;
      } catch (e) {
        alert(getText('rate_fail'));
        throw e;
      }
    }

    const dateInput = document.getElementById('date');
    const amountInput = document.getElementById('amount');
    const currencySelect = document.getElementById('currency');
    const descInput = document.getElementById('description');
    const categorySelect = document.getElementById('category');
    const btnAdd = document.getElementById('btn-add');
    const btnAutoCat = document.getElementById('btn-auto-categorize');
    const tbody = document.getElementById('expense-tbody');
    const monthSelect = document.getElementById('month-select');
    const monthTotalEl = document.getElementById('month-total');
    const categorySummaryEl = document.getElementById('category-summary');
    const langSelect = document.getElementById('lang-select');

    let monthlyChart = null;

    function initDefaults() {
      dateInput.value = todayStr();
      monthSelect.value = currentMonthStr();
    }

    async function handleAddExpense() {
      const date = dateInput.value || todayStr();
      const amount = parseFloat(amountInput.value);
      const currency = currencySelect.value;
      const description = descInput.value.trim();
      let category = categorySelect.value;

      if (isNaN(amount) || amount <= 0) {
        alert(getText('alert_amount'));
        return;
      }

      if (category === 'auto') {
        category = autoCategorize(description);
      }

      let amountHKD = amount;
      if (currency !== 'HKD') {
        try {
          const rate = await getRateToHKD(currency);
          amountHKD = amount * rate;
        } catch {
          return;
        }
      }

      const expense = {
        id: uuid(),
        date,
        amountOriginal: amount,
        currency,
        amountHKD: parseFloat(amountHKD.toFixed(2)),
        description,
        category,
        createdAt: new Date().toISOString()
      };

      expenses.push(expense);
      saveToStorage();
      renderTable();
      renderSummary();
      renderChart();

      amountInput.value = '';
      descInput.value = '';
      categorySelect.value = 'auto';
    }

    function handleAutoCategorizeClick() {
      const description = descInput.value.trim();
      if (!description) {
        alert(getText('alert_desc_first'));
        return;
      }
      const cat = autoCategorize(description);
      categorySelect.value = cat;
    }

    function handleDeleteExpense(id) {
      if (!confirm(getText('confirm_delete'))) return;
      expenses = expenses.filter(e => e.id !== id);
      saveToStorage();
      renderTable();
      renderSummary();
      renderChart();
    }

    function renderTable() {
      tbody.innerHTML = '';
      const sorted = [...expenses].sort((a, b) => {
        if (a.date === b.date) {
          return (b.createdAt || '').localeCompare(a.createdAt || '');
        }
        return b.date.localeCompare(a.date);
      });

      sorted.forEach(exp => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-slate-50";

        const tdDate = document.createElement('td');
        tdDate.className = "px-2 py-1.5 whitespace-nowrap";
        tdDate.textContent = exp.date;

        const tdDesc = document.createElement('td');
        tdDesc.className = "px-2 py-1.5";
        tdDesc.textContent = exp.description || '';

        const tdOrig = document.createElement('td');
        tdOrig.className = "px-2 py-1.5 text-right";
        tdOrig.textContent = `${exp.currency} ${exp.amountOriginal.toFixed(2)}`;

        const tdHKD = document.createElement('td');
        tdHKD.className = "px-2 py-1.5 text-right font-medium text-sky-700";
        tdHKD.textContent = `HKD ${exp.amountHKD.toFixed(2)}`;

        const tdCat = document.createElement('td');
        tdCat.className = "px-2 py-1.5";
        const badge = document.createElement('span');
        badge.className = "inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-medium text-slate-700";
        badge.textContent = exp.category;
        tdCat.appendChild(badge);

        const tdAction = document.createElement('td');
        tdAction.className = "px-2 py-1.5";
        const btn = document.createElement('button');
        btn.className = "inline-flex items-center rounded-md bg-rose-500 px-2.5 py-1 text-[11px] font-medium text-white shadow-sm hover:bg-rose-600 focus:outline-none focus:ring-1 focus:ring-rose-500";
        btn.textContent = getText('btn_delete');
        btn.onclick = () => handleDeleteExpense(exp.id);
        tdAction.appendChild(btn);

        tr.appendChild(tdDate);
        tr.appendChild(tdDesc);
        tr.appendChild(tdOrig);
        tr.appendChild(tdHKD);
        tr.appendChild(tdCat);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    function getSelectedMonth() {
      return monthSelect.value || currentMonthStr();
    }

    function renderSummary() {
      const month = getSelectedMonth();
      const monthExpenses = expenses.filter(e => e.date.slice(0, 7) === month);

      let total = 0;
      const byCategory = {};

      monthExpenses.forEach(e => {
        total += e.amountHKD;
        if (!byCategory[e.category]) byCategory[e.category] = 0;
        byCategory[e.category] += e.amountHKD;
      });

      monthTotalEl.textContent = 'HKD ' + total.toFixed(2);

      categorySummaryEl.innerHTML = '';
      const cats = Object.keys(byCategory).sort((a, b) => byCategory[b] - byCategory[a]);
      if (cats.length === 0) {
        const p = document.createElement('p');
        p.className = "text-sm text-slate-500";
        p.textContent = getText('no_data_month');
        categorySummaryEl.appendChild(p);
        return;
      }

      cats.forEach(cat => {
        const div = document.createElement('div');
        div.className = "flex items-center justify-between text-sm py-0.5";
        const amount = byCategory[cat];
        const percent = total > 0 ? (amount / total * 100) : 0;
        div.innerHTML = `
          <span class="text-slate-700">${cat}</span>
          <span class="text-slate-900 font-medium">HKD ${amount.toFixed(2)}
            <span class="text-slate-500 text-xs ml-1">(${percent.toFixed(1)}%)</span>
          </span>
        `;
        categorySummaryEl.appendChild(div);
      });
    }

    function getMonthlyTotals() {
      const map = {};
      expenses.forEach(e => {
        const month = e.date.slice(0, 7);
        if (!map[month]) map[month] = 0;
        map[month] += e.amountHKD;
      });
      const months = Object.keys(map).sort();
      const totals = months.map(m => parseFloat(map[m].toFixed(2)));
      return { months, totals };
    }

    function renderChart() {
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      const { months, totals } = getMonthlyTotals();

      if (monthlyChart) {
        monthlyChart.destroy();
      }

      monthlyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: getText('chart_title'),
            data: totals,
            borderColor: '#0ea5e9',
            backgroundColor: 'rgba(14,165,233,0.12)',
            tension: 0.25,
            fill: true,
            pointRadius: 3
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              title: { display: false }
            },
            y: {
              title: { display: false },
              beginAtZero: true
            }
          }
        }
      });
    }

    function init() {
      loadFromStorage();
      initDefaults();

      // 初始化語言
      const lang = getLang();
      langSelect.value = lang;
      applyLanguage(lang);

      renderTable();
      renderSummary();
      renderChart();

      btnAdd.addEventListener('click', handleAddExpense);
      btnAutoCat.addEventListener('click', handleAutoCategorizeClick);
      monthSelect.addEventListener('change', renderSummary);

      langSelect.addEventListener('change', () => {
        const newLang = langSelect.value;
        applyLanguage(newLang);
        renderTable();
        renderSummary();
        renderChart();
      });
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
